{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <style>
        .swiper { width: 100%; height: 520px; }
    </style>
{% endblock %}


{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        {% csrf_token %}
        {% if pets_to_swipe %}
            <div class="swiper my-4">
                <div class="swiper-wrapper">
                    {% for pet in pets_to_swipe %}
                        <div class="swiper-slide" data-pet-id="{{ pet.id }}">
                            <div class="card shadow-lg">
                                {% with pet.petphoto_set.first as first_photo %}
                                    {% if first_photo %}
                                        <img src="{{ first_photo.image.url }}" class="card-img-top" alt="Foto de {{ pet.name }}" style="height: 400px; object-fit: cover;">
                                    {% else %}
                                        <div class="d-flex justify-content-center align-items-center bg-secondary text-white" style="height: 400px;"><span>Sem foto</span></div>
                                    {% endif %}
                                {% endwith %}
                                <div class="card-body">
                                    <h4 class="card-title">{{ pet.name }}, {{ pet.age }}</h4>
                                    <p class="card-text text-muted">{{ pet.breed }}</p>
                                    <p class="card-text">{{ pet.bio }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="text-center p-5 glass-card">
                <h4>Parabéns!</h4>
                <p class="lead">Você já viu todos os pets disponíveis. Volte mais tarde para ver novos perfis!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}


{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

            const swiper = new Swiper('.swiper', {
                effect: 'cards',
                grabCursor: true,
                resistanceRatio: 0.85,
                cardsEffect: {
                    rotate: true,
                    perSlideRotate: 5,
                },
            });

            function sendSwipeAction(petId, liked) {
                fetch('/api/swipe/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 'swiped_pet_id': petId, 'liked': liked })
                })
                .then(response => response.ok ? response.json() : Promise.reject(response.status))
                .then(data => console.log('Resposta do Django:', data))
                .catch(error => console.error('Erro na requisição fetch:', error));
            }

            // ===============================================================
            // INÍCIO DA CORREÇÃO FINAL DOS BUGS
            // ===============================================================

            // Função central para lidar com a ação de swipe
            function handleSwipe(liked) {
                // O slide que acabou de ser deslizado é sempre o que estava ativo antes da transição.
                // Usamos 'swiper.previousIndex' para obter seu índice.
                const swipedSlideIndex = swiper.previousIndex;
                const swipedSlide = swiper.slides[swipedSlideIndex];

                if (!swipedSlide) return; // Segurança extra

                const swipedPetId = swipedSlide.dataset.petId;

                // 1. Envia a ação para o Django
                sendSwipeAction(swipedPetId, liked);

                // 2. Remove o slide da pilha
                swiper.removeSlide(swipedSlideIndex);

                // 3. Atualiza o swiper para ele se reorganizar
                swiper.update();
            }

            // Escuta o evento específico de deslizar para a ESQUERDA (próximo slide)
            swiper.on('slideNextTransitionEnd', function() {
                handleSwipe(false); // false = 'pass'
            });

            // Escuta o evento específico de deslizar para a DIREITA (slide anterior)
            swiper.on('slidePrevTransitionEnd', function() {
                handleSwipe(true); // true = 'like'
            });

            // ===============================================================
            // FIM DA CORREÇÃO FINAL DOS BUGS
            // ===============================================================
        });
    </script>
{% endblock %}