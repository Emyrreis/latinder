{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <style>
        .swipe-container {
            position: relative;
            width: 100%;
            height: 650px;
            margin: 20px auto;
        }
        
        .card-stack {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .pet-card {
            position: absolute;
            width: 100%;
            max-width: 450px;
            left: 50%;
            transform: translateX(-50%);
            cursor: grab;
            transition: transform 0.3s ease, opacity 0.3s ease;
            user-select: none;
        }
        
        .pet-card:active {
            cursor: grabbing;
        }
        
        .pet-card.animating {
            transition: transform 0.5s ease, opacity 0.5s ease, rotate 0.5s ease;
        }
        
        /* Empilhamento dos cards */
        .pet-card:nth-child(1) { z-index: 10; }
        .pet-card:nth-child(2) { z-index: 9; transform: translateX(-50%) scale(0.95) translateY(10px); opacity: 0.9; }
        .pet-card:nth-child(3) { z-index: 8; transform: translateX(-50%) scale(0.90) translateY(20px); opacity: 0.7; }
        .pet-card:nth-child(n+4) { z-index: 7; transform: translateX(-50%) scale(0.85) translateY(30px); opacity: 0.5; }
        
        /* Indicadores de like/nope no card */
        .card-overlay {
            position: absolute;
            top: 20px;
            font-size: 4rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            z-index: 100;
            pointer-events: none;
        }
        
        .card-overlay.like {
            right: 20px;
            color: #2ecc71;
            transform: rotate(-20deg);
        }
        
        .card-overlay.nope {
            left: 20px;
            color: #e74c3c;
            transform: rotate(20deg);
        }
        
        .card-overlay.show {
            opacity: 1;
        }
        
        /* Bot√µes */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: -120px;
        }
        
        .btn-swipe {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-swipe:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn-swipe:active {
            transform: scale(0.95);
        }
        
        .btn-nope {
            background: #e74c3c;
            color: white;
        }
        
        .btn-like {
            background: #2ecc71;
            color: white;
        }
        
        /* Mensagem final */
        .end-message {
            text-align: center;
            padding: 50px;
        }
    </style>
{% endblock %}


{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        {% csrf_token %}
        
        {% if pets_to_swipe %}
            <div class="swipe-container">
                <div class="card-stack" id="cardStack">
                    {% for pet in pets_to_swipe %}
                        <div class="pet-card" data-pet-id="{{ pet.id }}">
                            <!-- Overlays de Like/Nope -->
                            <div class="card-overlay like">‚ù§Ô∏è</div>
                            <div class="card-overlay nope">‚ùå</div>
                            
                            <div class="card shadow-lg">
                                {% with pet.petphoto_set.first as first_photo %}
                                    {% if first_photo %}
                                        <img src="{{ first_photo.image.url }}" class="card-img-top" alt="Foto de {{ pet.name }}" style="height: 400px; object-fit: cover;">
                                    {% else %}
                                        <div class="d-flex justify-content-center align-items-center bg-secondary text-white" style="height: 400px;">
                                            <span>Sem foto</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                                <div class="card-body">
                                    <h4 class="card-title">{{ pet.name }}, {{ pet.age }}</h4>
                                    <p class="card-text text-muted">{{ pet.breed }}</p>
                                    <p class="card-text">{{ pet.bio }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Bot√µes de a√ß√£o -->
            <div class="swipe-buttons">
                <button class="btn-swipe btn-nope" id="btnNope">X</button>
                <button class="btn-swipe btn-like" id="btnLike">ü§ç</button>
            </div>
        {% else %}
            <div class="text-center p-5 glass-card">
                <h4>Parab√©ns!</h4>
                <p class="lead">Voc√™ j√° viu todos os pets dispon√≠veis. Volte mais tarde para ver novos perfis!</p>
            </div>
        {% endif %}
        
        <!-- Mensagem de fim (oculta inicialmente) -->
        <div class="end-message glass-card" id="endMessage" style="display: none;">
            <h4>Fim da Fila!</h4>
            <p class="lead">Voc√™ j√° viu todos os pets dispon√≠veis por enquanto. Volte mais tarde para ver novos perfis!</p>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
            const cardStack = document.getElementById('cardStack');
            const endMessage = document.getElementById('endMessage');
            let cards = Array.from(document.querySelectorAll('.pet-card'));
            
            // Envia a a√ß√£o de like/pass para o backend Django
            function sendSwipeAction(petId, liked) {
                fetch('/api/swipe/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': csrfToken 
                    },
                    body: JSON.stringify({ 
                        'swiped_pet_id': petId, 
                        'liked': liked 
                    })
                 })
                .then(response => response.ok ? response.json() : Promise.reject(response.status))
                .then(data => {
                    console.log('Swipe registrado:', liked ? 'Match' : 'Pass');
        
                    // Verifica se houve match
                    if (data.match) {
                        alert('Voc√™ tem um novo match! üíï');
                    }
                })
                .catch(error => console.error('Erro:', error));
            }
            
            // Fun√ß√£o para remover card com anima√ß√£o
            function removeCard(card, liked) {
                const petId = card.dataset.petId;
                
                // S√≥ envia para o backend se for um pet v√°lido
                if (petId) {
                    sendSwipeAction(petId, liked);
                }
                
                // Anima√ß√£o de sa√≠da
                card.classList.add('animating');
                const direction = liked ? 1 : -1;
                card.style.transform = `translateX(${direction * 150}%) rotate(${direction * 30}deg)`;
                card.style.opacity = '0';
                
                // Remove do DOM ap√≥s anima√ß√£o
                setTimeout(() => {
                    card.remove();
                    cards = cards.filter(c => c !== card);
                    
                    // Verifica se acabaram os cards
                    if (cards.length === 0) {
                        cardStack.style.display = 'none';
                        endMessage.style.display = 'block';
                    }
                }, 500);
            }
            
            // Configurar Hammer.js para cada card
            cards.forEach((card, index) => {
                if (index > 0) return; // S√≥ o primeiro card √© interativo
                
                const hammer = new Hammer(card);
                const likeOverlay = card.querySelector('.card-overlay.like');
                const nopeOverlay = card.querySelector('.card-overlay.nope');
                
                let isPanning = false;
                
                // Configurar pan (arrastar)
                hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL, threshold: 0 });
                
                hammer.on('panstart', function() {
                    isPanning = true;
                    card.style.transition = 'none';
                });
                
                hammer.on('panmove', function(event) {
                    if (!isPanning) return;
                    
                    const xMulti = event.deltaX * 0.03;
                    const yMulti = event.deltaY / 80;
                    const rotate = xMulti * 10;
                    
                    card.style.transform = `translateX(calc(-50% + ${event.deltaX}px)) translateY(${event.deltaY}px) rotate(${rotate}deg)`;
                    
                    // Mostrar overlays baseado na dire√ß√£o
                    const opacity = Math.abs(event.deltaX) / 100;
                    if (event.deltaX > 0) {
                        // Arrastando para DIREITA = LIKE
                        likeOverlay.style.opacity = Math.min(opacity, 1);
                        nopeOverlay.style.opacity = 0;
                    } else {
                        // Arrastando para ESQUERDA = NOPE
                        nopeOverlay.style.opacity = Math.min(opacity, 1);
                        likeOverlay.style.opacity = 0;
                    }
                });
                
                hammer.on('panend', function(event) {
                    if (!isPanning) return;
                    isPanning = false;
                    
                    card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                    
                    // Threshold para decidir se foi um swipe v√°lido
                    const threshold = 120;
                    
                    if (event.deltaX > threshold) {
                        // LIKE - swipe para DIREITA
                        removeCard(card, true);
                    } else if (event.deltaX < -threshold) {
                        // PASS - swipe para ESQUERDA
                        removeCard(card, false);
                    } else {
                        // N√£o passou do threshold, volta para posi√ß√£o original
                        card.style.transform = 'translateX(-50%)';
                        likeOverlay.style.opacity = 0;
                        nopeOverlay.style.opacity = 0;
                    }
                });
            });
            
            // Bot√µes manuais
            document.getElementById('btnLike')?.addEventListener('click', function() {
                const topCard = cards[0];
                if (topCard) {
                    const likeOverlay = topCard.querySelector('.card-overlay.like');
                    likeOverlay.style.opacity = 1;
                    setTimeout(() => removeCard(topCard, true), 200);
                }
            });
            
            document.getElementById('btnNope')?.addEventListener('click', function() {
                const topCard = cards[0];
                if (topCard) {
                    const nopeOverlay = topCard.querySelector('.card-overlay.nope');
                    nopeOverlay.style.opacity = 1;
                    setTimeout(() => removeCard(topCard, false), 200);
                }
            });
            
            // Reconfigurar Hammer.js ap√≥s remover um card
            const originalRemoveCard = removeCard;
            removeCard = function(card, liked) {
                originalRemoveCard(card, liked);
                setTimeout(() => {
                    if (cards.length > 0) {
                        const newTopCard = cards[0];
                        const hammer = new Hammer(newTopCard);
                        // ... (repetir configura√ß√£o do Hammer)
                    }
                }, 100);
            };
        });
    </script>
{% endblock %}